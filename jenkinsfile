pipeline {
    agent any

    environment {
        APP_NAME        = "vmware-inventory"
        NETWORK         = "app-network"
        GREEN_CONTAINER = "green"
        BLUE_CONTAINER  = "blue"
        NGINX_CONTAINER = "nginx"
        APP_PORT        = "8501"
    }

    stages {

        stage('Checkout Source') {
            steps {
                checkout scm
            }
        }

        stage('Build Green Image') {
            steps {
                sh '''
                docker build -t ${APP_NAME}:green .
                '''
            }
        }

        stage('Run Green Container') {
            steps {
                sh '''
                docker network inspect ${NETWORK} >/dev/null 2>&1 || \
                docker network create ${NETWORK}

                docker stop ${GREEN_CONTAINER} || true
                docker rm ${GREEN_CONTAINER} || true

                docker run -d \
                  --name ${GREEN_CONTAINER} \
                  --network ${NETWORK} \
                  ${APP_NAME}:green
                '''
            }
        }

        stage('Health Check Green') {
            steps {
                sh '''
                echo "ðŸ” Checking Green container health..."

                for i in $(seq 1 30); do
                  if docker exec ${GREEN_CONTAINER} \
                     curl -sf http://127.0.0.1:${APP_PORT}/_stcore/health; then
                    echo "âœ… Green is healthy"
                    exit 0
                  fi

                  echo "â³ Streamlit not ready yet... retrying ($i/30)"
                  sleep 2
                done

                echo "âŒ Green failed health check"
                docker logs ${GREEN_CONTAINER}
                exit 1
                '''
            }
        }

        stage('Switch Traffic to Green') {
            steps {
                sh '''
                echo "ðŸ” Switching NGINX traffic to Green..."

                docker exec ${NGINX_CONTAINER} sh -c '
cat > /etc/nginx/conf.d/default.conf <<EOF
upstream streamlit_app {
    server green:8501;
}

server {
    listen 80;

    location / {
        proxy_pass http://streamlit_app;
    }
}
EOF
'
                docker exec ${NGINX_CONTAINER} nginx -s reload
                '''
            }
        }

        stage('Remove Blue') {
            steps {
                sh '''
                echo "ðŸ§¹ Removing Blue container..."

                docker stop ${BLUE_CONTAINER} || true
                docker rm ${BLUE_CONTAINER} || true

                docker tag ${APP_NAME}:green ${APP_NAME}:blue
                '''
            }
        }
    }

    post {
        failure {
            echo "âŒ Deployment failed. Blue is still serving traffic."
        }
        success {
            echo "âœ… Blue-Green deployment completed successfully!"
        }
    }
}
